# Jenkins MSTest-plugin

[![Build Status](https://ci.jenkins.io/buildStatus/icon?job=Plugins/mstest-plugin/master)](https://ci.jenkins.io/job/Plugins/mstest-plugin/master)
[![Contributors](https://img.shields.io/github/contributors/jenkinsci/mstest-plugin.svg)](https://github.com/jenkinsci/mstest-plugin/graphs/contributors)
[![Jenkins Plugin](https://img.shields.io/jenkins/plugin/v/mstest.svg)](https://github.com/jenkinsci/mstest-plugin/releases/tag/mstest-1.0.0)
[![Jenkins Plugin Installs](https://img.shields.io/jenkins/plugin/i/mstest.svg?color=blue)](https://plugins.jenkins.io/mstest)

## Description

This plugin converts [MSTest](http://msdn.microsoft.com/en-us/library/ms182486.aspx) TRX test reports into JUnit XML reports so it can be 
integrated with Jenkin'sJUnit features. 
This plugin converts the .coveragexml files found in the project workspace to the EMMA format.

You can use [MSTestRunner plugin](https://wiki.jenkins-ci.org/display/JENKINS/MSTestRunner+Plugin) or
[VsTestRunner plugin](https://wiki.jenkins-ci.org/display/JENKINS/VsTestRunner+Plugin) 
to run the test and use this plugin to process the results.

 The MSTest plugin analyzes the test execution reports (TRX) files generated by mstest and vstest.console. 
These files include a test execution summary, and detailed data about what happened during the tests execution. 
Along with the test execution records, vstest or mstest may also include a link towards the code coverage data 
collected during the tests execution. 
These coverage files have a binary, proprietary format, and you have to convert them to XML before that the MSTest
publisher is invoked.

This plugin converts the test records to the JUnit format, and adds them to the build report. 
The plugin also searches for the link to the code coverage data. 
If it is present, and it contains valuable data, the plugin converts it to the Emma format by means of an ad-hoc XSL
transformation.

If you want to show the coverage data on the build report, it is up to you to add the Emma plugin to your Jenkins instance, 
and to add the corresponding post-build action to your build. 
The coverage reports will be somewhere in the build workspace, and their name will match thepattern: `emma\coverage.xml`. 
Apart from the Emma plugin, which is rather outdated, probably also other plugins can complete the same task
(for example, the JaCoCo plugin).

## Pipeline Support

The MSTest plugin supports the pipeline plugin (and/or Jenkinsfile build definitions). 
The plugin call be called with an instruction like

```
step([$class: 'MSTestPublisher', testResultsFile:"**/*.trx", failOnError: true, keepLongStdio: true])
```

Or with its shortest alternative:

```
mstest testResultsFile:"**/*.trx", keepLongStdio: true
```

## Code Coverage Support

Since the code coverage data has a binary, proprietary format, and that the tools capable of handling them are released 
under a proprietary license along with the develipment environments, you will have to perform the data conversion yourself. 
Here's how.

### Code Coverage Data Conversion

To convert the binary VSTest.Console output to the 
[Microsoft CoverageDS XML format](https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.coverage.analysis.coverageds.aspx), 
you may use one of the prebuilt applications referenced in the V0.14 release notes below, 
or you can build the following converter application:

*CoverageCoverter.exe*

```c#
    class Program
    {
        static int Main(string[] args)
        {
            if ( args.Length != 2)
            {
                Console.WriteLine("Coverage Convert - reads VStest binary code coverage data, and outputs it in XML format.");
                Console.WriteLine("Usage:  ConverageConvert <sourcefile> <destinationfile>");
                return 1;
            }

            CoverageInfo info;
            string path;
            try
            {
                path = System.IO.Path.GetDirectoryName(args[0]);
                info = CoverageInfo.CreateFromFile(args[0], new string[] { path }, new string[] { });
            }
            catch (Exception e)
            {
                Console.WriteLine("Error opening coverage data: {0}",e.Message);
                return 1;
            }

            CoverageDS data = info.BuildDataSet();

            try
            {
                data.WriteXml(args[1]);
            }
            catch (Exception e)
            {

                Console.WriteLine("Error writing to output file: {0}", e.Message);
                return 1;
            }

            return 0;
        }
    }
```

The CoverageDS and CoverageInfo types are being exposed by the Microsoft.VisualStudio.Coverage.Analysis.dll 
(official documentation: https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.coverage.analysis.coverageds.aspx,
article explaining how to use these assemblies with a nice step-by-step:
https://blogs.msdn.microsoft.com/phuene/2009/12/01/programmatic-coverage-analysis-in-visual-studio-2010/) 

The following Powershell build step will find one binary coverage data file in your workspace and convert it to XML format, 
assuming you use the default TestResults directory. 
(Modify as necessary to handle multiple coverage files)

*Powershell build step for CoverageDS XML Conversion*

```
$generatedCoverageFile = $(get-ChildItem -Path .\TestResults -Recurse -Include *coverage)[0]
CoverageConverter $generatedCoverageFile TestResults\vstest.coveragexml
```

*Can I use Microsoft's CodeCoverage.exe for data conversion?*

Microsoft supplies _C:\Program Files (x86)\Microsoft Visual Studio 1X.0\Team Tools\Dynamic Code Coverage Tools\CodeCoverage.exe_ 
with Visual Studio. 
But unfortunately this tool uses an XML format distinct from the CoverageDS format used by vstest and mstest, 
and is not compatible with the MSTest plugin. 
If you are interested in this topic, and you've some experience with XSL, there are a couple of transforms to
convert back and forth in the
[github repository](https://github.com/jenkinsci/mstest-plugin/commit/702a6d57e0a3b09953a6e276412f2c9e7be84ff1).


[SonarCloud report](https://sonarcloud.io/dashboard/index/org.jvnet.hudson.plugins:mstest)
